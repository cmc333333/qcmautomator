tags: ["books"]

options:
  volumes:
  - name: secrets
    path: /etc/app/

steps:
- id: get-secret
  name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
  args:
  - bash
  - -c
  - >-
    gsutil
    --impersonate-service-account books-executor@${PROJECT_ID}.iam.gserviceaccount.com
    cp gs://${PROJECT_ID}-books-secrets/goodreads_user_id.enc /etc/app/goodreads_user_id.enc
    &&
    gcloud kms decrypt --location us --keyring books --key secrets
    --impersonate-service-account books-executor@${PROJECT_ID}.iam.gserviceaccount.com
    --plaintext-file /etc/app/goodreads_user_id --ciphertext-file /etc/app/goodreads_user_id.enc
- id: run
  name: gcr.io/${PROJECT_ID}/app:production
  dir: /usr/src/app
  args:
  - python
  - -m
  - qcmautomator.books
